---
import { Markdown } from "astro-remote"

import ImageRow from "@/components/article/originals/image/ImageRow"
import H2 from "@/components/article/standards/heading/H2"
import Image from "@/components/article/standards/Image"
import Paragraph from "@/components/article/standards/Paragraph"
import Layout from "@/components/layout/Layout.astro"
import Hero from "@/components/templates/hero/Hero"
import { STRAPI_BASE_URL } from "@/constants/value"
import styles from "@/pages/_[articleUrlId].module.css"
import { getAllArticleUrlIds, getArticle } from "@/services/api"
import { isDefined } from "@/utils/isDefined"

import type { GetStaticPaths } from "astro"

/**
 * 存在する記事のパス一覧をexportする
 * @returns GetStaticPaths
 */
export const getStaticPaths: GetStaticPaths = async () => {
  const allArticleUrlIds = await getAllArticleUrlIds()

  return allArticleUrlIds.map(articleUrlId => ({
    params: {
      articleUrlId
    }
  }))
}

const { articleUrlId } = Astro.params

if (typeof articleUrlId !== "string") {
  throw new Error("記事のURL IDが不正です")
}

const article = await getArticle(articleUrlId)

if (!isDefined(article)) {
  throw new Error("記事情報が存在しません")
}

const heroProps = {
  createdAt: article.forceCreatedAt ?? article.createdAt ?? "2000/01/01",
  updatedAt: article.forceUpdatedAt ?? article.updatedAt ?? "2000/01/01",
  commentCount: 1, // TODO: 実際の値を反映させる必要がある
  backNumber: 1, // TODO: 実際の値を反映させる必要がある
  title: article.title,
  tags: (article.tags as Array<string>) ?? [],
  thumbnailUrl: `${STRAPI_BASE_URL}${article.thumbnail?.data?.attributes?.url}`
}
---

<Layout title={`${article?.title} | 麩菓子の雑記帳`}>
  <div class={styles.articlePageMain}>
    <div class={styles.heroSp}>
      <Hero device="sp" {...heroProps} />
    </div>

    <div class={styles.heroPc}>
      <Hero device="pc" {...heroProps} />
    </div>

    <div class={styles.body}>
      <Markdown
        components={{
          h2: H2,
          p: Paragraph,
          img: Image,
          ImageRow
        }}
        content={article?.body}
        sanitize={{
          allowComponents: true
        }}
      />

      <p class={styles.built}>この記事は 2024/04/29 13:35:41 にビルドされました</p>
    </div>
    {/* TODO: コメントエリア */}
  </div>
</Layout>
